#!/bin/bash -x
#
# This script is called by cowbuilder.
#
set -e

cat << 'EOF' > /etc/apt/apt.conf.d/00proxy
Acquire::http { Proxy "http://127.0.0.1:3142"; };
EOF

cat << 'EOF' > /etc/apt/sources.list
deb http://127.0.0.1:3142/deb.debian.org/debian stretch main contrib non-free
deb-src http://127.0.0.1:3142/deb.debian.org/debian stretch main contrib non-free
## Security updates
deb http://127.0.0.1:3142/deb.debian.org/debian-security stretch/updates main contrib non-free
deb-src http://127.0.0.1:3142/deb.debian.org/debian-security stretch/updates main contrib non-free
EOF

apt update -y
apt -y install gnupg2 ca-certificates

# Add subgraph repo to the cow
cat << EOF > /etc/apt/sources.list.d/subgraph.list
deb http://127.0.0.1:3142/devrepo.subgraph.com/subgraph/ aaron main
EOF

cat << EOF > /tmp/subgraph-apt-key.asc
-----BEGIN PGP PUBLIC KEY BLOCK-----

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
=iiwv
-----END PGP PUBLIC KEY BLOCK-----
EOF

apt-key add /tmp/subgraph-apt-key.asc
rm /tmp/subgraph-apt-key.asc

apt dist-upgrade -y
apt clean
